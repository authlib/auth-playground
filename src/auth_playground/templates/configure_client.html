{% extends "layout.html" %}

{% block title %}Configure OAuth Client{% endblock %}

{% block content %}

    <h2>Choose a configuration method</h2>

    <p>
        The {{ g.server_config.display_name }} configuration has been successfully loaded.
        Now register your client at the {{ g.server_config.display_name }}.
        Select one of the following options:
    </p>

    {% if g.server_config and g.server_config.specs and g.server_config.specs.oauth_2_dynamic_client_registration %}
        <article>
            <header>
                <h3>Dynamic registration</h3>
            </header>

            <p>This server supports <a href="https://datatracker.ietf.org/doc/html/rfc7591">dynamic client registration</a>. Provide an Initial Access Token if required, then click the button to automatically register this application.</p>

            <form method="POST" action="{{ url_for('routes.client_dynamic_registration') }}">
                {{ dynamic_registration_form.hidden_tag() }}

                <label for="{{ dynamic_registration_form.initial_access_token.id }}">
                    {{ dynamic_registration_form.initial_access_token.label }}
                    {% if dynamic_registration_form.initial_access_token.description %}
                        <small>{{ dynamic_registration_form.initial_access_token.description }}</small>
                    {% endif %}
                </label>

                {% if dynamic_registration_form.initial_access_token.errors %}
                    {% for error in dynamic_registration_form.initial_access_token.errors %}
                        <small class="error">{{ error }}</small>
                    {% endfor %}
                {% endif %}

                <div role="group">
                    {{ dynamic_registration_form.initial_access_token(class="form-control") }}
                    {{ dynamic_registration_form.submit(class="primary") }}
                </div>
            </form>

            <details>
                <summary role="button" class="outline">What happens next?</summary>
                <ul>
                    <li>
                        A new OAuth client will be created automatically at the {{ g.server_config.display_name }},
                        with the correct configuration,
                    </li>
                    <li>Client ID and Secret will be generated by the server,</li>
                    <li>Configuration will be stored in your session.</li>
                </ul>
            </details>
        </article>
    {% endif %}

    <article>
        <header>
            <h3>Manual configuration</h3>
        </header>

        <p>Manually register the client at the {{ g.server_config.display_name }},
            then enter the client credentials below.</p>

        <details>
            <summary role="button" class="outline">{{ g.server_config.display_name }} configuration</summary>
            <p>When creating your OAuth client at the {{ g.server_config.display_name }}, configure these URIs:</p>
            <p><strong>Redirect URIs (<code>redirect_uris</code>):</strong></p>
            <ul>
                <li><code>{{ url_for('routes.login_callback', _external=True) }}</code></li>
                <li><code>{{ url_for('routes.register_callback', _external=True) }}</code></li>
            </ul>
            <p><strong>Post-Logout Redirect URIs (<code>post_logout_redirect_uris</code>):</strong></p>
            <ul>
                <li><code>{{ url_for('routes.logout_callback', _external=True) }}</code></li>
            </ul>
        </details>

        <form method="POST" action="{{ url_for('routes.configure_client') }}">
            {{ client_form.hidden_tag() }}

            <label for="{{ client_form.client_id.id }}">
                {{ client_form.client_id.label }}
                {{ client_form.client_id(class="form-control") }}
                {% if client_form.client_id.description %}
                    <small>{{ client_form.client_id.description }}</small>
                {% endif %}
            </label>

            {% if client_form.client_id.errors %}
                {% for error in client_form.client_id.errors %}
                    <small class="error">{{ error }}</small>
                {% endfor %}
            {% endif %}

            <label for="{{ client_form.client_secret.id }}">
                {{ client_form.client_secret.label }}
                {{ client_form.client_secret(class="form-control") }}
                {% if client_form.client_secret.description %}
                    <small>{{ client_form.client_secret.description }}</small>
                {% endif %}
            </label>

            {% if client_form.client_secret.errors %}
                {% for error in client_form.client_secret.errors %}
                    <small class="error">{{ error }}</small>
                {% endfor %}
            {% endif %}

            {{ client_form.submit() }}
        </form>
    </article>

{% endblock %}
